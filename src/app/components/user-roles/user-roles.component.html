<div class="container mt-4">
  <h2>Quản lý User Roles</h2>
  <dx-data-grid
    [dataSource]="users"
    [showBorders]="true"
    [allowColumnReordering]="true"
    [allowColumnResizing]="true"
    [columnAutoWidth]="true">

    <dxi-column dataField="username" caption="Tên đăng nhập"></dxi-column>
    <dxi-column dataField="fullName" caption="Họ tên"></dxi-column>
    <dxi-column dataField="roles" caption="Vai trò" [allowEditing]="false" cellTemplate="rolesTemplate"></dxi-column>
    <dxi-column caption="Hành động" cellTemplate="actionTemplate"></dxi-column>

    <!-- Template hiển thị roles -->
    <div *dxTemplate="let data of 'rolesTemplate'">
      {{ data.data.roles?.join(', ') || 'Chưa có role' }}
    </div>

    <!-- Template nút quản lý -->
    <div *dxTemplate="let data of 'actionTemplate'">
      <dx-button text="Quản lý Roles" (onClick)="openRoleModal(data.data)"></dx-button>
    </div>
  </dx-data-grid>

  <!-- Popup quản lý roles -->
  <dx-popup [visible]="showRolePopup" title="Quản lý Roles cho {{ currentUser.username }}" (onHiding)="showRolePopup = false">
    <dx-data-grid [dataSource]="allRoles" [selectedRowKeys]="selectedRoleIds" (onSelectionChanged)="onRoleSelectionChanged($event)">
      <dxo-selection mode="multiple"></dxo-selection>
      <dxi-column dataField="name" caption="Vai trò"></dxi-column>
      <dxi-column dataField="description" caption="Mô tả"></dxi-column>
    </dx-data-grid>
    <button class="btn btn-success mt-2" (click)="saveUserRoles()">Lưu</button>
  </dx-popup>
</div>